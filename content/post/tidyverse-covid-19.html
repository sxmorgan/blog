---
title: 'Introduction to the Tidyverse'
subtitle: 'COVID-19 Testing in the US'
author: Morgan Essex
date: '2020-04-27'
slug: tidyverse-covid-19
output:
  blogdown::html_page:
    toc: true
tags:
  - tidyverse
  - R
---


<div id="TOC">
<ul>
<li><a href="#tidy-philosophy">Tidy Philosophy</a></li>
<li><a href="#import">Import</a></li>
<li><a href="#munge">Munge</a></li>
<li><a href="#plot">Plot</a></li>
</ul>
</div>

<p>The <a href="https://www.tidyverse.org/packages/">tidyverse</a> is a set of actively developed and well-maintained R packages to facilitate the typical data analysis workflow, shown below. Most but not all of the core tidyverse packages (there are now 8) were designed by Hadley Wickham, chief scientist at R Studio since 2013. He’s written a book, <a href="https://r4ds.had.co.nz/"><em>R for Data Science</em></a>, which is an incredible resource for all programming levels, and given several talks which are of course available on YouTube if you find yourself becoming a nerd too… <a href="https://www.youtube.com/watch?v=9YTNYT1maa4">here’s a good one</a> from the <a href="https://vizbi.org/">VIZBI</a> conference at EMBL last year.</p>
<p>In 2007 he published probably the most well-known component of the tidyverse, <code>ggplot2</code>, as an open source implementation of <a href="https://towardsdatascience.com/a-comprehensive-guide-to-the-grammar-of-graphics-for-effective-visualization-of-multi-dimensional-1f92b4ed4149"><em>The Grammar of Graphics</em></a>, a statistical textbook from the 1980s that looked at the fundamentals of data visualization. Grammar is an attribute of language that tells us how elements must be expressed in order to be understood, and where natural languages predominately evolve the grammars that distinguish them functionally, programming languages can be created or tweaked to suit a specific need from the beginning. <em>The Grammar of Graphics</em> is just a rationally-designed graphic language embedded in a programming language (hence <strong>gg</strong>plot).</p>
<p>What it accomplished for the process of data visualization - the ability to describe and construct an array of visualizations in a layered, structured manner - was extended to other aspects of the data analysis process and refined over years to become the tidyverse in 2016. R users who have ever melted or reshaped a data frame might be curious to know that those packages were also Hadley’s work and key predecessors of the <code>dplyr</code> and <code>tidyr</code> packages in the current core tidyverse.</p>
<p><img src="../data/covid-tidyverse/data.science.process.png" /> <br><br> I personally really like the graphic above because it unites the computational data sciences regardless of motivating discipline or question and encapsulates my entire job as a researcher: it starts with data and ends with me communicating something I’ve learned from the nonlinear process of exploring that data. This process was already strenuous during my master’s thesis, so I knew that I would need to get a lot better at organizing my efforts and gain a lot of technical proficiency in order to complete my PhD. The tidyverse attracted me because it offered consistency and complete workflow coverage, which felt like were the best ways to attain the fluency I needed to do my job effectively.</p>
<p>At most I hope I can inspire someone else to interact with their data science questions differently too - with more curiosity and flow, and less frustration and disorganization - and at the very least I hope people will consider using chaining syntax for more readable code.</p>
<div id="tidy-philosophy" class="section level3">
<h3>Tidy Philosophy</h3>
</div>
<div id="import" class="section level3">
<h3>Import</h3>
<p>We’re going to be using data from the COVID Tracking Project in the US. The API is easily accessible, and a woman already created a wrapper package for R to make accessing historical and current statistics incredibly simple.</p>
<div class="figure">
<img src="../data/covid-tidyverse/covidtracking.png" />

</div>
<p>Calling <code>library(tidyverse)</code> will load all the functions we’ll need today, except we must also import <code>magrittr</code>, which provides us with the pipe (<code>%&gt;%</code>) operator and some ‘aliases’ useful when using chaining syntax.</p>
<pre class="r"><code>library(tidyverse)  # data science toolkit
library(magrittr)   # corresponding operators
library(covid19us)  # scrapes https://covidtracking.com/ API
library(ggsci)      # custom color palettes
library(ggpubr)     # publication-ready plots</code></pre>
<p>Then, let’s load the complete longitudinal dataset and select the variables that will be relevant for our analysis.</p>
<pre class="r"><code>states.data &lt;- get_states_daily() %&gt;%
    select(c(&#39;state&#39;,&#39;date&#39;,&#39;positive&#39;,&#39;negative&#39;,&#39;death&#39;,&#39;total_test_results&#39;))

states.data</code></pre>
<pre><code>## # A tibble: 3,321 x 6
##    state date       positive negative death total_test_results
##    &lt;chr&gt; &lt;date&gt;        &lt;int&gt;    &lt;int&gt; &lt;int&gt;              &lt;int&gt;
##  1 AK    2020-05-03      368    21210     9              21578
##  2 AL    2020-05-03     7725    84775   290              92500
##  3 AR    2020-05-03     3431    49459    76              52890
##  4 AS    2020-05-03        0       57     0                 57
##  5 AZ    2020-05-03     8640    72479   362              81119
##  6 CA    2020-05-03    53616   662135  2215             715751
##  7 CO    2020-05-03    16225    63681   832              79906
##  8 CT    2020-05-03    29287    73206  2436             102493
##  9 DC    2020-05-03     5016    18086   251              23102
## 10 DE    2020-05-03     5208    18529   177              23737
## # … with 3,311 more rows</code></pre>
<p>Additionally, we’re going to pull a csv file from <a href="https://worldpopulationreview.com/" class="uri">https://worldpopulationreview.com/</a> that contains state-abbreviation pairs (e.g. CA, California) that we’ll use later to ‘beautify’ our plots.</p>
<pre class="r"><code>states.abbrev &lt;- read_csv(&#39;https://worldpopulationreview.com/static/states/abbr-name-list.csv&#39;)

states.abbrev</code></pre>
<pre><code>## # A tibble: 51 x 2
##    name                 abbreviation
##    &lt;chr&gt;                &lt;chr&gt;       
##  1 Alabama              AL          
##  2 Alaska               AK          
##  3 Arizona              AZ          
##  4 Arkansas             AR          
##  5 California           CA          
##  6 Colorado             CO          
##  7 Connecticut          CT          
##  8 Delaware             DE          
##  9 District Of Columbia DC          
## 10 Florida              FL          
## # … with 41 more rows</code></pre>
<p>Lastly, from that same website I have downloaded the (projected) 2020 census estimates, which we’ll read in and use to standardize our data to tests per 100,000 residents.</p>
<pre class="r"><code>states.population &lt;- &#39;../data/covid-tidyverse/covid.us.state.population.csv&#39; %&gt;%
    read_csv() %&gt;%
    select(c(&#39;rank&#39;,&#39;State&#39;,&#39;Pop&#39;))

states.population</code></pre>
<pre><code>## # A tibble: 52 x 3
##     rank State               Pop
##    &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt;
##  1     1 California     39937489
##  2     2 Texas          29472295
##  3     3 Florida        21992985
##  4     4 New York       19440469
##  5     5 Pennsylvania   12820878
##  6     6 Illinois       12659682
##  7     7 Ohio           11747694
##  8     8 Georgia        10736059
##  9     9 North Carolina 10611862
## 10    10 Michigan       10045029
## # … with 42 more rows</code></pre>
</div>
<div id="munge" class="section level3">
<h3>Munge</h3>
<p>To munge is to manipulate raw data. We’ll start by combining the three different datasets we have loaded to look at testing rates among the most populated states.</p>
<pre class="r"><code>testing.data &lt;- states.data %&gt;%
    left_join(states.abbrev, by = c(&#39;state&#39; = &#39;abbreviation&#39;)) %&gt;%
    left_join(states.population, by = c(&#39;name&#39; = &#39;State&#39;))

# peeking at newly joined variables
testing.data %&gt;%
    select(c(&#39;state&#39;,&#39;date&#39;,&#39;name&#39;,&#39;rank&#39;,&#39;Pop&#39;))</code></pre>
<pre><code>## # A tibble: 3,321 x 5
##    state date       name                  rank      Pop
##    &lt;chr&gt; &lt;date&gt;     &lt;chr&gt;                &lt;dbl&gt;    &lt;dbl&gt;
##  1 AK    2020-05-03 Alaska                  49   734002
##  2 AL    2020-05-03 Alabama                 24  4908621
##  3 AR    2020-05-03 Arkansas                33  3038999
##  4 AS    2020-05-03 &lt;NA&gt;                    NA       NA
##  5 AZ    2020-05-03 Arizona                 14  7378494
##  6 CA    2020-05-03 California               1 39937489
##  7 CO    2020-05-03 Colorado                21  5845526
##  8 CT    2020-05-03 Connecticut             29  3563077
##  9 DC    2020-05-03 District Of Columbia    NA       NA
## 10 DE    2020-05-03 Delaware                46   982895
## # … with 3,311 more rows</code></pre>
<p>Then we’ll use the lubridate package within the tidyverse to quickly split the dates into month and day components so we can look at data from the 9th of March.</p>
<pre class="r"><code>testing.data %&lt;&gt;%
    mutate(month = lubridate::month(date)) %&gt;%
    mutate(day = lubridate::day(date)) %&gt;%
    filter(month &gt;= 3) %&gt;%
    filter(day &gt;= 9)

testing.data %&gt;%
    select(c(&#39;state&#39;,&#39;date&#39;,&#39;total_test_results&#39;,&#39;month&#39;,&#39;day&#39;))</code></pre>
<pre><code>## # A tibble: 2,482 x 5
##    state date       total_test_results month   day
##    &lt;chr&gt; &lt;date&gt;                  &lt;int&gt; &lt;dbl&gt; &lt;int&gt;
##  1 AK    2020-04-30              19119     4    30
##  2 AL    2020-04-30              87196     4    30
##  3 AR    2020-04-30              48379     4    30
##  4 AS    2020-04-30                  3     4    30
##  5 AZ    2020-04-30              71786     4    30
##  6 CA    2020-04-30             625337     4    30
##  7 CO    2020-04-30              71059     4    30
##  8 CT    2020-04-30              97133     4    30
##  9 DC    2020-04-30              20079     4    30
## 10 DE    2020-04-30              21820     4    30
## # … with 2,472 more rows</code></pre>
</div>
<div id="plot" class="section level3">
<h3>Plot</h3>
</div>
