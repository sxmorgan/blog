<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>data&#43;science/posts/tidyverse-covid-19/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href='/hugo-theme-console/css/terminal-0.7.1.min.css'>
    <link rel="stylesheet" href='/hugo-theme-console/css/animate-3.7.2.min.css'>
    <link rel="stylesheet" href='/hugo-theme-console/css/console.css'>
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
    <link rel="icon" 
      type="image/png" 
      href="/favicon-comp.png"><meta property="og:title" content="A Simple Tidyverse Workflow" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/tidyverse-covid-19/" /><meta property="article:published_time" content="2020-05-02T00:00:00+00:00" />



<meta name="twitter:title" content="A Simple Tidyverse Workflow"/>
<meta name="twitter:description" content="Exploratory data analysis with COVID-19 testing and prognosis in the US."/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="/" class="no-style site-name">data&#43;science</a>:~/ <a href='posts'></a> <a href='/'>posts</a>/<a href='tidyverse-covid'></a> <a href='//'>tidyverse-covid</a>/
            </header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="/posts/" typeof="ListItem">posts/</a></li>
                
                <li><a href="/resources/" typeof="ListItem">resources/</a></li>
                
                <li><a href="/tags/" typeof="ListItem">tags/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated zoomIn fast">
        
<h1>A Simple Tidyverse Workflow</h1>

2 May 2020 // 11' read

<br/>

  <link rel="stylesheet" href="tomorrow.css" type="text/css" />

<div id="TOC">
<ul>
<li><a href="#import">Import</a></li>
<li><a href="#munge">Munge</a></li>
<li><a href="#visualize">Visualize</a></li>
<li><a href="#summarize">Summarize</a></li>
</ul>
</div>

<p>This post is intended to be a follow up resource from my presentation for members of the ECRC. If you haven’t seen those or are new here, check out my previous <a href="../why-tidyverse">post</a> on why you should use the tidyverse.</p>
<p>In later posts I will go through a more complete workflow in more fine-grained detail with microbiome-specific examples, but for this introductory demo we are going to be using data from the <a href="https://covidtracking.com/">COVID Tracking Project</a> in the US. I have little experience teaching so this is an exercise for me as well, and new data makes that easier to keep you in mind.</p>
<p>One of my favorite things about R is the active development community: we don’t need to download any files or even access this data through the API, because someone’s already created a <code>covid19us</code> wrapper package to do this for us with a single line of code in R. However, at the time of publication, this function sadly <a href="https://github.com/aedobbyn/covid19us/issues/17">isn’t working</a>, so we’ll use the API.</p>
<div id="import" class="section level2">
<h2>Import</h2>
<p>Calling <code>library(tidyverse)</code> will load all the packages and functions we’ll need, including the pipe (<code>%&gt;%</code>) operator, but I will explicitly load <code>magrittr</code> so that I can use some aliases and the debatable but economical <code>%&lt;&gt;%</code> operator to save a variable in place without typing the name twice. I’m also going to load the <a href="https://lubridate.tidyverse.org/">lubridate</a> package for dealing with dates, and I always load the <a href="https://cran.r-project.org/web/packages/ggsci/vignettes/ggsci.html">ggsci</a> and <a href="https://rpkgs.datanovia.com/ggpubr/index.html">ggpubr</a> packages for my plots.</p>
<pre class="r"><code># library(covid19us) 
library(tidyverse)
library(magrittr)
library(lubridate)
library(ggsci) 
library(ggpubr)</code></pre>
<p>Then, let’s load the complete longitudinal dataset, which defaults to a tibble and select the testing variables that will be relevant for our analysis.</p>
<pre class="r"><code>states.data &lt;- &#39;https://covidtracking.com/api/v1/states/daily.csv&#39; %&gt;%
    read_csv() %&gt;%
    select(c(&#39;state&#39;,&#39;date&#39;,&#39;positive&#39;,&#39;negative&#39;,&#39;death&#39;,&#39;total&#39;)) 

states.data</code></pre>
<pre><code>## # A tibble: 3,937 x 6
##    state     date positive negative death   total
##    &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
##  1 AK    20200514      387    31375    10   31762
##  2 AL    20200514    10968   131017   467  141985
##  3 AR    20200514     4236    71582    97   75818
##  4 AS    20200514        0      105     0     105
##  5 AZ    20200514    12674   121664   624  134338
##  6 CA    20200514    73164  1031487  3032 1104651
##  7 CO    20200514    20475    94044  1062  114519
##  8 CT    20200514    35464   114098  3219  149562
##  9 DC    20200514     6736    26263   358   32999
## 10 DE    20200514     7223    29634   260   36857
## # … with 3,927 more rows</code></pre>
<p>Additionally, I have downloaded the (projected) 2020 census estimates of all 50 states + DC and Puerto Rico from <a href="https://worldpopulationreview.com" class="uri">https://worldpopulationreview.com</a>, which we’ll read in and use to standardize our data to tests per 100,000 residents.</p>
<pre class="r"><code>states.population &lt;- &#39;data/covid.us.state.population.csv&#39; %&gt;%
    read_csv() %&gt;%
    select(c(&#39;rank&#39;,&#39;State&#39;,&#39;Pop&#39;)) 

states.population</code></pre>
<pre><code>## # A tibble: 52 x 3
##     rank State               Pop
##    &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt;
##  1     1 California     39937489
##  2     2 Texas          29472295
##  3     3 Florida        21992985
##  4     4 New York       19440469
##  5     5 Pennsylvania   12820878
##  6     6 Illinois       12659682
##  7     7 Ohio           11747694
##  8     8 Georgia        10736059
##  9     9 North Carolina 10611862
## 10    10 Michigan       10045029
## # … with 42 more rows</code></pre>
<p>Lastly, we’re going to pull a csv directly from that website which contains state-abbreviation pairs (e.g. CA, California) that we’ll use later to ‘beautify’ our plots. The ‘of’ in District of Columbia on this last is capitalized, so we’ll manually change this to avoid a mismatch later. We’ll also add a row for Puerto Rico, since that abbreviation is weirdly missing.</p>
<pre class="r"><code>states.abbrev &lt;- &#39;https://worldpopulationreview.com/static/states/abbr-name-list.csv&#39; %&gt;%
    read_csv() %&gt;%
    mutate(name = stringr::str_replace(name, &#39;Of&#39;, &#39;of&#39;)) %&gt;%
    add_row(name = &#39;Puerto Rico&#39;, abbreviation = &#39;PR&#39;)

states.abbrev</code></pre>
<pre><code>## # A tibble: 52 x 2
##    name                 abbreviation
##    &lt;chr&gt;                &lt;chr&gt;       
##  1 Alabama              AL          
##  2 Alaska               AK          
##  3 Arizona              AZ          
##  4 Arkansas             AR          
##  5 California           CA          
##  6 Colorado             CO          
##  7 Connecticut          CT          
##  8 Delaware             DE          
##  9 District of Columbia DC          
## 10 Florida              FL          
## # … with 42 more rows</code></pre>
</div>
<div id="munge" class="section level2">
<h2>Munge</h2>
<p>To munge is to manipulate raw data. We’ll start by combining the three different datasets we have loaded to look at testing rates among the most populated states.</p>
<pre class="r"><code>raw.testing.data &lt;- states.data %&gt;%
    left_join(states.abbrev, by = c(&#39;state&#39; = &#39;abbreviation&#39;)) %&gt;%
    left_join(states.population, by = c(&#39;name&#39; = &#39;State&#39;)) %&gt;%
    rename(full_name = &#39;name&#39;) %&gt;%
    filter(!is.na(full_name))

# peeking at newly joined variables
raw.testing.data %&gt;%
    select(c(&#39;state&#39;,&#39;date&#39;,&#39;full_name&#39;,&#39;rank&#39;,&#39;Pop&#39;))</code></pre>
<pre><code>## # A tibble: 3,697 x 5
##    state     date full_name             rank      Pop
##    &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;                &lt;dbl&gt;    &lt;dbl&gt;
##  1 AK    20200514 Alaska                  49   734002
##  2 AL    20200514 Alabama                 24  4908621
##  3 AR    20200514 Arkansas                33  3038999
##  4 AZ    20200514 Arizona                 14  7378494
##  5 CA    20200514 California               1 39937489
##  6 CO    20200514 Colorado                21  5845526
##  7 CT    20200514 Connecticut             29  3563077
##  8 DC    20200514 District of Columbia    50   720687
##  9 DE    20200514 Delaware                46   982895
## 10 FL    20200514 Florida                  3 21992985
## # … with 3,687 more rows</code></pre>
<p>Then we’ll use the <code>lubridate</code> package to quickly split the dates into month and day components so we can look at data from the 9th of March through the end of April. The <code>month()</code> and <code>day()</code> commands extract those elements respectively, while <code>ymd()</code> tells the package what the original date format is so it knows how to parse.</p>
<pre class="r"><code>testing.data &lt;- raw.testing.data %&gt;%
    mutate_at(vars(date), ~ as_date(ymd(.))) %&gt;%
    filter(date &gt; &#39;2020-03-09&#39;)

# peeking at new dates
testing.data %&gt;%
    select(c(&#39;state&#39;,&#39;date&#39;,&#39;total&#39;))</code></pre>
<pre><code>## # A tibble: 3,424 x 3
##    state date         total
##    &lt;chr&gt; &lt;date&gt;       &lt;dbl&gt;
##  1 AK    2020-05-14   31762
##  2 AL    2020-05-14  141985
##  3 AR    2020-05-14   75818
##  4 AZ    2020-05-14  134338
##  5 CA    2020-05-14 1104651
##  6 CO    2020-05-14  114519
##  7 CT    2020-05-14  149562
##  8 DC    2020-05-14   32999
##  9 DE    2020-05-14   36857
## 10 FL    2020-05-14  610065
## # … with 3,414 more rows</code></pre>
<p>Now that we have our dates sorted out, we can standardize our data so that the cases reported are per 100k residents. We will select only these new columns and the other variables that we’ll need to create some basic longitudinal scatter plots.</p>
<pre class="r"><code>testing.data %&lt;&gt;%
    mutate(pop.factor = Pop/100000) %&gt;%
    mutate(tests.std = total/pop.factor) %&gt;%
    mutate(deaths.std = death/pop.factor) %&gt;%
    mutate(positive.std = positive/pop.factor) %&gt;%
    mutate(negative.std = negative/pop.factor) %&gt;%
    select(c(&#39;full_name&#39;,&#39;date&#39;,&#39;tests.std&#39;,&#39;deaths.std&#39;,&#39;positive.std&#39;,&#39;negative.std&#39;))</code></pre>
<p>By default, our states are sorted alphabetically, but what if we wanted to sort them according to their testing rates?</p>
<p>As a quick console sidebar, let’s see which states have the highest testing rates.</p>
<pre class="r"><code>testing.data %&gt;%
    arrange(desc(tests.std))</code></pre>
<pre><code>## # A tibble: 3,424 x 6
##    full_name    date       tests.std deaths.std positive.std negative.std
##    &lt;chr&gt;        &lt;date&gt;         &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
##  1 Rhode Island 2020-05-14     9620.       44.3        1138.        8482.
##  2 Rhode Island 2020-05-13     9272.       43.7        1121.        8151.
##  3 Rhode Island 2020-05-12     9017.       42.0        1100.        7918.
##  4 Rhode Island 2020-05-11     8837.       40.7        1084.        7753.
##  5 Rhode Island 2020-05-10     8636.       40.0        1067.        7569.
##  6 Rhode Island 2020-05-09     8315.       39.6        1040.        7274.
##  7 Rhode Island 2020-05-08     8073.       37.8        1021.        7053.
##  8 Rhode Island 2020-05-07     7794.       36.7         997.        6797.
##  9 Rhode Island 2020-05-06     7515.       35.0         966.        6549.
## 10 Rhode Island 2020-05-05     7237.       33.6         940.        6297.
## # … with 3,414 more rows</code></pre>
<p>In order to get a better overview and ignore the date column, we can group our row observations by state and then nest the remaining data, which will leave us with a state column that is sorted by the standardized testing rate in descending order.</p>
<pre class="r"><code>testing.data %&gt;%
    arrange(desc(tests.std)) %&gt;%
    group_by(full_name) %&gt;%
    nest()</code></pre>
<pre><code>## # A tibble: 52 x 2
## # Groups:   full_name [52]
##    full_name            data             
##    &lt;chr&gt;                &lt;list&gt;           
##  1 Rhode Island         &lt;tibble [66 × 5]&gt;
##  2 New York             &lt;tibble [66 × 5]&gt;
##  3 North Dakota         &lt;tibble [66 × 5]&gt;
##  4 Massachusetts        &lt;tibble [64 × 5]&gt;
##  5 New Mexico           &lt;tibble [66 × 5]&gt;
##  6 Louisiana            &lt;tibble [66 × 5]&gt;
##  7 New Jersey           &lt;tibble [66 × 5]&gt;
##  8 Utah                 &lt;tibble [66 × 5]&gt;
##  9 District of Columbia &lt;tibble [66 × 5]&gt;
## 10 Tennessee            &lt;tibble [66 × 5]&gt;
## # … with 42 more rows</code></pre>
</div>
<div id="visualize" class="section level2">
<h2>Visualize</h2>
<p>Our <code>testing.data</code> is now nice and tidy, but if you’re familiar with <code>ggplot2</code> then you proabably already know that our data is not quite ‘plot’ tidy. This is not an official term, but I find it useful because it reminds me that data almost always needs to be tidied in specific ways before it can be easily plotted.</p>
<p>Right now it is difficult to plot our four different testing variables on the same plot, since they’re in four different columns which would require four different <code>geom_point()</code> commands, each with a different y-axis variable. In order for us to have plot tidy data, we want to have a tibble with only three data columns: our independent (x) and dependent (y) variables, as well as time (date) since this is longitudinal.</p>
<p>For this the <code>dplyr::pivot_longer()</code> function will be essential. We’ll tell it to ignore the state and date columns, while combining our four test rate columns into two new ones: <code>std.metric</code> and <code>std.value</code>.</p>
<pre class="r"><code>testing.data %&gt;%
    pivot_longer(cols = -c(&#39;date&#39;,&#39;full_name&#39;),
                 names_to = &#39;std.metric&#39;,
                 values_to = &#39;std.value&#39;)</code></pre>
<pre><code>## # A tibble: 13,696 x 4
##    full_name date       std.metric   std.value
##    &lt;chr&gt;     &lt;date&gt;     &lt;chr&gt;            &lt;dbl&gt;
##  1 Alaska    2020-05-14 tests.std      4327.  
##  2 Alaska    2020-05-14 deaths.std        1.36
##  3 Alaska    2020-05-14 positive.std     52.7 
##  4 Alaska    2020-05-14 negative.std   4275.  
##  5 Alabama   2020-05-14 tests.std      2893.  
##  6 Alabama   2020-05-14 deaths.std        9.51
##  7 Alabama   2020-05-14 positive.std    223.  
##  8 Alabama   2020-05-14 negative.std   2669.  
##  9 Arkansas  2020-05-14 tests.std      2495.  
## 10 Arkansas  2020-05-14 deaths.std        3.19
## # … with 13,686 more rows</code></pre>
<p>Perfect. But if we want to sort our states by <code>tests.std</code> like we did above, we need to do that <em>before</em> we collapse that variable to get everything plot tidy, hence why we didn’t use <code>%&lt;&gt;%</code> above to save our new tibble. Because of a weird quirk in the <code>facet_wrap()</code> command we’ll use later, we’re going to add an explicit <code>ordered</code> column with a unique identifier for each row.</p>
<p>Once I start making “plot tidy” manipulations I create a new <code>plot.data</code> tibble That way, I have my <code>testing.data</code> tibble available for console sidebars to help me refine the information in <code>plot.data</code> according to what I want <code>ggplot2</code> to use and display.</p>
<!-- https://stackoverflow.com/questions/41199496/order-of-factor-levels-in-facet-wrap -->
<pre class="r"><code>plot.data &lt;- testing.data %&gt;%
    group_by(full_name) %&gt;%
    arrange(desc(tests.std)) %&gt;%
    nest() %&gt;%
    ungroup() %&gt;%
    mutate(ordered = 1:n()) %&gt;%
    unnest(data)

plot.data %&gt;%
    select(c(&#39;full_name&#39;,&#39;tests.std&#39;,&#39;ordered&#39;))</code></pre>
<pre><code>## # A tibble: 3,424 x 3
##    full_name    tests.std ordered
##    &lt;chr&gt;            &lt;dbl&gt;   &lt;int&gt;
##  1 Rhode Island     9620.       1
##  2 Rhode Island     9272.       1
##  3 Rhode Island     9017.       1
##  4 Rhode Island     8837.       1
##  5 Rhode Island     8636.       1
##  6 Rhode Island     8315.       1
##  7 Rhode Island     8073.       1
##  8 Rhode Island     7794.       1
##  9 Rhode Island     7515.       1
## 10 Rhode Island     7237.       1
## # … with 3,414 more rows</code></pre>
<p>Now we have to collapse our four testing variables like we did earlier but didn’t save. We’ll use the same command we did above, except we will also include our new <code>ordered</code> column in the excluded variables parameter, and we’ll be calling it on <code>plot.data</code> this time.</p>
<pre class="r"><code>plot.data %&lt;&gt;%
    pivot_longer(cols = -c(&#39;date&#39;,&#39;full_name&#39;,&#39;ordered&#39;),
                 names_to = &#39;std.metric&#39;,
                 values_to = &#39;std.value&#39;)

plot.data</code></pre>
<pre><code>## # A tibble: 13,696 x 5
##    full_name    date       ordered std.metric   std.value
##    &lt;chr&gt;        &lt;date&gt;       &lt;int&gt; &lt;chr&gt;            &lt;dbl&gt;
##  1 Rhode Island 2020-05-14       1 tests.std       9620. 
##  2 Rhode Island 2020-05-14       1 deaths.std        44.3
##  3 Rhode Island 2020-05-14       1 positive.std    1138. 
##  4 Rhode Island 2020-05-14       1 negative.std    8482. 
##  5 Rhode Island 2020-05-13       1 tests.std       9272. 
##  6 Rhode Island 2020-05-13       1 deaths.std        43.7
##  7 Rhode Island 2020-05-13       1 positive.std    1121. 
##  8 Rhode Island 2020-05-13       1 negative.std    8151. 
##  9 Rhode Island 2020-05-12       1 tests.std       9017. 
## 10 Rhode Island 2020-05-12       1 deaths.std        42.0
## # … with 13,686 more rows</code></pre>
<p>Finally, we’ll beautify <code>plot.data</code> and order our <code>std.metric</code> variable and change the names to be a bit more intuitive for the final plots.</p>
<pre class="r"><code>plot.data %&lt;&gt;%
    mutate_at(vars(std.metric), ~ fct_relevel(., &#39;tests.std&#39;,&#39;negative.std&#39;,
                                              &#39;positive.std&#39;,&#39;deaths.std&#39;)) %&gt;%
    mutate_at(vars(std.metric), ~ fct_recode(., 
                                              `Total Test Results` = &#39;tests.std&#39;,
                                             `Negative Tests` = &#39;negative.std&#39;,
                                              `Positive Tests` = &#39;positive.std&#39;,
                                              `Deaths` = &#39;deaths.std&#39;)) %&gt;%
    mutate_at(vars(full_name), ~ fct_reorder(., ordered))

plot.data</code></pre>
<pre><code>## # A tibble: 13,696 x 5
##    full_name    date       ordered std.metric         std.value
##    &lt;fct&gt;        &lt;date&gt;       &lt;int&gt; &lt;fct&gt;                  &lt;dbl&gt;
##  1 Rhode Island 2020-05-14       1 Total Test Results    9620. 
##  2 Rhode Island 2020-05-14       1 Deaths                  44.3
##  3 Rhode Island 2020-05-14       1 Positive Tests        1138. 
##  4 Rhode Island 2020-05-14       1 Negative Tests        8482. 
##  5 Rhode Island 2020-05-13       1 Total Test Results    9272. 
##  6 Rhode Island 2020-05-13       1 Deaths                  43.7
##  7 Rhode Island 2020-05-13       1 Positive Tests        1121. 
##  8 Rhode Island 2020-05-13       1 Negative Tests        8151. 
##  9 Rhode Island 2020-05-12       1 Total Test Results    9017. 
## 10 Rhode Island 2020-05-12       1 Deaths                  42.0
## # … with 13,686 more rows</code></pre>
<pre class="r"><code>y.axis.max &lt;- plot.data %&gt;%
    magrittr::use_series(std.value) %&gt;%
    na.omit() %&gt;%
    max() %&gt;%
    ceiling()

testing.plot &lt;- plot.data %&gt;%
    ggplot(aes(x = date, y = std.value)) +
    geom_point(aes(color = std.metric, shape = std.metric)) +
    # label every 3 weeks on the major x axis
    scale_x_date(date_breaks = &#39;3 weeks&#39;,
                 date_labels = &#39;%d.%m&#39;) +
    # my personal favorite color palette
    scale_color_futurama() +
    facet_wrap(~ full_name, ncol = 4) +
    # add title, remove x+y axis labels and legends
    labs(title = &#39;COVID-19 Testing and Prognosis in US States&#39;,
         x = &#39;&#39;, y = &#39;&#39;, color = &#39;Per 100k Residents:&#39;, shape = &#39;Per 100k Residents:&#39;) +
    theme_pubclean()

testing.plot</code></pre>
<p><img src="/posts/tidyverse-covid/index_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
<div id="summarize" class="section level2">
<h2>Summarize</h2>
<style type="text/css">
img {
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 70%;
    padding: 10px
}
</style>
</div>


tagged:  tutorial  tidyverse  r-stats  forslund-lab   
        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> and <a href="https://www.netlify.com/">Netlify</a>. 
</div>
    </div>
  </body>
</html>
